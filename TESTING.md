# Тестирование SQL Query Optimizer

## Обзор

Создан комплексный набор тестов для проверки всех возможностей SQL, поддерживаемых Apache Calcite. Тесты покрывают как базовые, так и продвинутые SQL конструкции, а также включают тесты производительности и стресс-тестирование.

## Структура тестов

### 1. SqlQueryOptimizerTest.java
Основные тесты для проверки базовых SQL возможностей:
- Простые SELECT запросы
- Условия WHERE (различные операторы)
- JOIN операции (INNER, LEFT, RIGHT, FULL)
- Агрегация и GROUP BY
- Сортировка и LIMIT/OFFSET
- Подзапросы
- UNION операции
- Разбиение запросов

### 2. AdvancedSqlFeaturesTest.java
Тесты для проверки продвинутых SQL возможностей:
- Оконные функции (ROW_NUMBER, RANK, LAG, LEAD)
- Рекурсивные CTE
- LATERAL JOIN
- JSON функции
- Математические функции
- Сложные CASE выражения
- Продвинутые агрегации (ROLLUP, CUBE, GROUPING SETS)
- Коррелированные подзапросы
- EXISTS/NOT EXISTS
- Self JOIN

### 3. PerformanceAndStressTest.java
Тесты производительности и стресс-тестирование:
- Производительность простых запросов
- Производительность сложных запросов
- Производительность больших JOIN
- Производительность агрегаций
- Производительность оконных функций
- Многопоточное тестирование
- Использование памяти
- Экстремальные пороги стоимости

## Запуск тестов

### Быстрый запуск всех тестов
```bash
./run-tests.sh
```

### Запуск отдельных тестовых наборов
```bash
# Основные SQL возможности
mvn test -Dtest=SqlQueryOptimizerTest

# Продвинутые SQL возможности
mvn test -Dtest=AdvancedSqlFeaturesTest

# Тесты производительности
mvn test -Dtest=PerformanceAndStressTest
```

### Запуск отдельных тестов
```bash
# Конкретный тест
mvn test -Dtest=SqlQueryOptimizerTest#testSimpleSelect

# Тесты по паттерну
mvn test -Dtest=*Test#test*Join*
```

## Проверяемые SQL возможности

### Базовые операции
- ✅ SELECT с различными колонками
- ✅ WHERE с простыми условиями
- ✅ WHERE с сложными условиями (AND, OR, IN, LIKE, BETWEEN)
- ✅ ORDER BY (ASC, DESC)
- ✅ LIMIT и OFFSET
- ✅ Алиасы таблиц и колонок

### JOIN операции
- ✅ INNER JOIN
- ✅ LEFT JOIN
- ✅ RIGHT JOIN
- ✅ FULL JOIN
- ✅ Множественные JOIN
- ✅ Self JOIN
- ✅ LATERAL JOIN
- ✅ JOIN с множественными условиями

### Агрегация
- ✅ COUNT, SUM, AVG, MIN, MAX
- ✅ COUNT(DISTINCT)
- ✅ GROUP BY
- ✅ HAVING
- ✅ ROLLUP
- ✅ CUBE
- ✅ GROUPING SETS
- ✅ Продвинутые агрегации (STDDEV, VARIANCE, PERCENTILE_CONT)

### Подзапросы
- ✅ Подзапросы в WHERE
- ✅ Подзапросы в SELECT
- ✅ Подзапросы в FROM
- ✅ Коррелированные подзапросы
- ✅ EXISTS и NOT EXISTS
- ✅ IN с подзапросами

### Оконные функции
- ✅ ROW_NUMBER()
- ✅ RANK() и DENSE_RANK()
- ✅ LAG() и LEAD()
- ✅ Агрегатные функции в окнах
- ✅ PARTITION BY
- ✅ Скользящие окна

### Специальные конструкции
- ✅ Рекурсивные CTE
- ✅ UNION и UNION ALL
- ✅ CASE выражения
- ✅ JSON функции
- ✅ Математические функции
- ✅ Строковые функции
- ✅ Функции дат

### Условия и фильтрация
- ✅ IS NULL / IS NOT NULL
- ✅ LIKE с различными паттернами
- ✅ BETWEEN
- ✅ IN с множественными значениями
- ✅ Сложные логические выражения

## Тесты производительности

### Метрики производительности
- Время выполнения запросов
- Использование памяти
- Количество созданных подзапросов
- Влияние порога стоимости на разбиение

### Стресс-тестирование
- Многопоточное выполнение
- Большие объемы данных
- Экстремальные пороги стоимости
- Длительные запросы

## Ожидаемые результаты

### Время выполнения
- Простые запросы: < 5 секунд
- Сложные запросы: < 10 секунд
- Запросы с большими JOIN: < 15 секунд
- Запросы с агрегацией: < 12 секунд
- Оконные функции: < 8 секунд

### Использование памяти
- Обычные запросы: < 100MB
- Сложные запросы: < 1GB
- Стресс-тесты: < 2GB

### Надежность
- Успешность оптимизации: > 95%
- Корректность результатов: 100%
- Обработка ошибок: 100%

## Настройка тестов

### Конфигурация метаданных
Тесты используют различные наборы метаданных:
- Базовые таблицы (employees, departments, orders)
- Расширенные таблицы (projects, skills, employee_projects)
- Большие таблицы (large_table, categories, dimensions)

### Конфигурация статистики
Статистика включает:
- Количество строк в таблицах
- Количество уникальных значений в колонках
- Количество NULL значений
- Различные размеры таблиц (от 10 до 1,000,000 строк)

### Параметры тестирования
- Пороги стоимости: от 1.0 до 1,000,000.0
- Количество потоков: 10
- Количество запросов на поток: 5
- Таймаут тестов: 60 секунд

## Интерпретация результатов

### Успешные тесты
- ✅ Все проверки пройдены
- ✅ Время выполнения в пределах нормы
- ✅ Использование памяти в пределах нормы
- ✅ Корректная структура результатов

### Неудачные тесты
- ❌ Ошибки парсинга SQL
- ❌ Ошибки оптимизации
- ❌ Превышение времени выполнения
- ❌ Превышение использования памяти
- ❌ Некорректная структура результатов

## Отладка тестов

### Логирование
```bash
# Включить подробное логирование
mvn test -Dtest=SqlQueryOptimizerTest -Dorg.slf4j.simpleLogger.defaultLogLevel=DEBUG

# Логирование только ошибок
mvn test -Dtest=SqlQueryOptimizerTest -Dorg.slf4j.simpleLogger.defaultLogLevel=ERROR
```

### Анализ результатов
```bash
# Показать подробный отчет
mvn test -Dtest=SqlQueryOptimizerTest -Dsurefire.useFile=false

# Сохранить отчет в файл
mvn test -Dtest=SqlQueryOptimizerTest -Dsurefire.reportFormat=xml
```

## Добавление новых тестов

### Структура теста
```java
@Test
public void testNewSqlFeature() {
    String sql = "SELECT * FROM table WHERE condition";
    OptimizationRequest request = createRequest(sql, 1000.0);
    OptimizationResult result = optimizer.optimize(request);
    
    assertOptimizationSuccess(result);
    // Дополнительные проверки
}
```

### Группировка тестов
- Группируйте тесты по функциональности
- Используйте описательные имена методов
- Добавляйте комментарии для сложных тестов
- Следуйте существующему стилю кода

## Интеграция с CI/CD

### Автоматический запуск
```yaml
# GitHub Actions пример
- name: Run Tests
  run: |
    chmod +x run-tests.sh
    ./run-tests.sh
```

### Уведомления
- Уведомления о неудачных тестах
- Отчеты о производительности
- Тренды времени выполнения

## Заключение

Комплексный набор тестов обеспечивает:
- Полное покрытие SQL возможностей Apache Calcite
- Проверку производительности и надежности
- Автоматизированное тестирование
- Детальную отчетность
- Простоту добавления новых тестов

Тесты гарантируют, что SQL Query Optimizer корректно обрабатывает все поддерживаемые Apache Calcite SQL конструкции и работает стабильно в различных условиях.




